<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · DifferentiationInterface.jl</title><meta name="title" content="Tutorial · DifferentiationInterface.jl"/><meta property="og:title" content="Tutorial · DifferentiationInterface.jl"/><meta property="twitter:title" content="Tutorial · DifferentiationInterface.jl"/><meta name="description" content="Documentation for DifferentiationInterface.jl."/><meta property="og:description" content="Documentation for DifferentiationInterface.jl."/><meta property="twitter:description" content="Documentation for DifferentiationInterface.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">DifferentiationInterface.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Start here</span><ul><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#Computing-a-gradient"><span>Computing a gradient</span></a></li><li><a class="tocitem" href="#Overwriting-a-gradient"><span>Overwriting a gradient</span></a></li><li><a class="tocitem" href="#Preparing-for-multiple-gradients"><span>Preparing for multiple gradients</span></a></li><li><a class="tocitem" href="#Switching-backends"><span>Switching backends</span></a></li></ul></li><li><a class="tocitem" href="../overview/">Overview</a></li><li><a class="tocitem" href="../backends/">Backends</a></li></ul></li><li><a class="tocitem" href="../api/">API reference</a></li><li><span class="tocitem">Advanced</span><ul><li><a class="tocitem" href="../design/">Package design</a></li><li><a class="tocitem" href="../extensions/">Package extensions</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Start here</a></li><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gdalle/DifferentiationInterface.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gdalle/DifferentiationInterface.jl/blob/main/DifferentiationInterface/docs/src/tutorial.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial"><a class="docs-heading-anchor" href="#Tutorial">Tutorial</a><a id="Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial" title="Permalink"></a></h1><p>We present a typical workflow with DifferentiationInterface.jl and showcase its potential performance benefits.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; using DifferentiationInterface</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; import ForwardDiff, Enzyme</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; using BenchmarkTools</code><code class="nohighlight hljs ansi" style="display:block;"></code></pre><h2 id="Computing-a-gradient"><a class="docs-heading-anchor" href="#Computing-a-gradient">Computing a gradient</a><a id="Computing-a-gradient-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-a-gradient" title="Permalink"></a></h2><p>A common use case of AD is optimizing real-valued functions with first- or second-order methods. Let&#39;s define a simple objective</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; f(x::AbstractArray) = sum(abs2, x)</code><code class="nohighlight hljs ansi" style="display:block;">f (generic function with 1 method)</code></pre><p>and a random input vector</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; x = [1.0, 2.0, 3.0];</code><code class="nohighlight hljs ansi" style="display:block;"></code></pre><p>To compute its gradient, we need to choose a &quot;backend&quot;, i.e. an AD package that DifferentiationInterface.jl will call under the hood. Most backend types are defined by <a href="https://github.com/SciML/ADTypes.jl">ADTypes.jl</a> and re-exported by DifferentiationInterface.jl. <a href="https://github.com/JuliaDiff/ForwardDiff.jl">ForwardDiff.jl</a> is very generic and efficient for low-dimensional inputs, so it&#39;s a good starting point:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; backend = AutoForwardDiff()</code><code class="nohighlight hljs ansi" style="display:block;">AutoForwardDiff{nothing, Nothing}(nothing)</code></pre><p>Now you can use DifferentiationInterface.jl to get the gradient:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; gradient(f, backend, x)</code><code class="nohighlight hljs ansi" style="display:block;">3-element Vector{Float64}:
 2.0
 4.0
 6.0</code></pre><p>Was that fast? <a href="https://github.com/JuliaCI/BenchmarkTools.jl">BenchmarkTools.jl</a> helps you answer that question.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime gradient($f, $backend, $x);</code><code class="nohighlight hljs ansi" style="display:block;">  654.335 ns (5 allocations: 528 bytes)</code></pre><p>More or less what you would get if you just used the API from ForwardDiff.jl:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime ForwardDiff.gradient($f, $x);</code><code class="nohighlight hljs ansi" style="display:block;">  687.452 ns (4 allocations: 432 bytes)</code></pre><p>Not bad, but you can do better.</p><h2 id="Overwriting-a-gradient"><a class="docs-heading-anchor" href="#Overwriting-a-gradient">Overwriting a gradient</a><a id="Overwriting-a-gradient-1"></a><a class="docs-heading-anchor-permalink" href="#Overwriting-a-gradient" title="Permalink"></a></h2><p>Since you know how much space your gradient will occupy, you can pre-allocate that memory and offer it to AD. Some backends get a speed boost from this trick.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; grad = zero(x)</code><code class="nohighlight hljs ansi" style="display:block;">3-element Vector{Float64}:
 0.0
 0.0
 0.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; grad = gradient!!(f, grad, backend, x)</code><code class="nohighlight hljs ansi" style="display:block;">3-element Vector{Float64}:
 2.0
 4.0
 6.0</code></pre><p>Note the double exclamation mark, which is a convention telling you that <code>grad</code> <em>may or may not</em> be overwritten, but will be returned either way (see <a href="../overview/#Variants">this section</a> for more details).</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime gradient!!($f, _grad, $backend, $x) evals=1 setup=(_grad=similar($x));</code><code class="nohighlight hljs ansi" style="display:block;">  651.000 ns (4 allocations: 448 bytes)</code></pre><p>For some reason the in-place version is not much better than your first attempt. However, it has one less allocation, which corresponds to the gradient vector you provided. Don&#39;t worry, you&#39;re not done yet.</p><h2 id="Preparing-for-multiple-gradients"><a class="docs-heading-anchor" href="#Preparing-for-multiple-gradients">Preparing for multiple gradients</a><a id="Preparing-for-multiple-gradients-1"></a><a class="docs-heading-anchor-permalink" href="#Preparing-for-multiple-gradients" title="Permalink"></a></h2><p>Internally, ForwardDiff.jl creates some data structures to keep track of things. These objects can be reused between gradient computations, even on different input values. We abstract away the preparation step behind a backend-agnostic syntax:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; extras = prepare_gradient(f, backend, x)</code><code class="nohighlight hljs ansi" style="display:block;">DifferentiationInterfaceForwardDiffExt.ForwardDiffGradientExtras{ForwardDiff.GradientConfig{ForwardDiff.Tag{typeof(Main.f), Float64}, Float64, 3, Vector{ForwardDiff.Dual{ForwardDiff.Tag{typeof(Main.f), Float64}, Float64, 3}}}}(ForwardDiff.GradientConfig{ForwardDiff.Tag{typeof(Main.f), Float64}, Float64, 3, Vector{ForwardDiff.Dual{ForwardDiff.Tag{typeof(Main.f), Float64}, Float64, 3}}}((Partials(1.0, 0.0, 0.0), Partials(0.0, 1.0, 0.0), Partials(0.0, 0.0, 1.0)), ForwardDiff.Dual{ForwardDiff.Tag{typeof(Main.f), Float64}, Float64, 3}[Dual{ForwardDiff.Tag{typeof(Main.f), Float64}}(1.0,1.0,0.0,0.0), Dual{ForwardDiff.Tag{typeof(Main.f), Float64}}(2.0,0.0,1.0,0.0), Dual{ForwardDiff.Tag{typeof(Main.f), Float64}}(3.0,0.0,0.0,1.0)]))</code></pre><p>You don&#39;t need to know what this object is, you just need to pass it to the gradient operator.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; grad = zero(x);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; grad = gradient!!(f, grad, backend, x, extras)</code><code class="nohighlight hljs ansi" style="display:block;">3-element Vector{Float64}:
 2.0
 4.0
 6.0</code></pre><p>Preparation makes the gradient computation much faster, and (in this case) allocation-free.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime gradient!!($f, _grad, $backend, $x, _extras) evals=1 setup=(
           _grad=similar($x);
           _extras=prepare_gradient($f, $backend, $x)
       );</code><code class="nohighlight hljs ansi" style="display:block;">  60.000 ns (0 allocations: 0 bytes)</code></pre><h2 id="Switching-backends"><a class="docs-heading-anchor" href="#Switching-backends">Switching backends</a><a id="Switching-backends-1"></a><a class="docs-heading-anchor-permalink" href="#Switching-backends" title="Permalink"></a></h2><p>The whole point of DifferentiationInterface.jl is that you can easily experiment with different AD solutions. Typically, for gradients, reverse mode AD might be a better fit. So let&#39;s try the state-of-the-art <a href="https://github.com/EnzymeAD/Enzyme.jl">Enzyme.jl</a>!</p><p>For this one, the backend definition is slightly more involved, because you need to feed the &quot;mode&quot; to the object from ADTypes.jl:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; backend2 = AutoEnzyme(Enzyme.Reverse)</code><code class="nohighlight hljs ansi" style="display:block;">AutoEnzyme{EnzymeCore.ReverseMode{false, EnzymeCore.FFIABI}}(EnzymeCore.ReverseMode{false, EnzymeCore.FFIABI}())</code></pre><p>But once it is done, things run smoothly with exactly the same syntax:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; gradient(f, backend2, x)</code><code class="nohighlight hljs ansi" style="display:block;">3-element Vector{Float64}:
 2.0
 4.0
 6.0</code></pre><p>And you can run the same benchmarks:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; @btime gradient!!($f, _grad, $backend2, $x, _extras) evals=1 setup=(
           _grad=similar($x);
           _extras=prepare_gradient($f, $backend2, $x)
       );</code><code class="nohighlight hljs ansi" style="display:block;">  29.000 ns (0 allocations: 0 bytes)</code></pre><p>Not only is it blazingly fast, you achieved this speedup without looking at the docs of either ForwardDiff.jl or Enzyme.jl! In short, DifferentiationInterface.jl allows for easy testing and comparison of AD backends. If you want to go further, check out the <a href="https://gdalle.github.io/DifferentiationInterface.jl/DifferentiationInterfaceTest/dev/tutorial/">DifferentiationTest.jl tutorial</a>.</p><script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
mermaid.initialize({
    startOnLoad: true,
    theme: "neutral"
});
</script></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../overview/">Overview »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Tuesday 9 April 2024 06:02">Tuesday 9 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
